import { GoogleGenAI, Type, Schema } from "@google/genai";
import { ComplaintFormState, GeneratedComplaint } from "../types";

const responseSchema: Schema = {
  type: Type.OBJECT,
  properties: {
    title: {
      type: Type.STRING,
      description: "The formatted title of the complaint",
    },
    body: {
      type: Type.STRING,
      description: "The fully formatted body text of the complaint",
    },
  },
  required: ["title", "body"],
};

const SYSTEM_INSTRUCTION = `
Ты - элитный юрист-помощник в Прокуратуре штата Houston (Majestic RP).
Твоя задача - взять "сырые" данные от гражданина и ПРЕОБРАЗОВАТЬ их в ИДЕАЛЬНО отформатированный текст жалобы по строгому регламенту.

ПРАВИЛА ДЛЯ "title":
1. Используй "Порядковый номер" для создания заголовка.
   Пример: "Порядковый номер: 123" -> "ОБРАЩЕНИЕ В ОФИС ГЕНЕРАЛЬНОГО ПРОКУРОРА №123"

ПРАВИЛА ДЛЯ "body" (многострочная строка):
1. Первая строка: "От гражданина штата Сан-Андреас {Имя Фамилия}"
2. Вторая строка: "В Офис Генерального прокурора"
3. Третья строка: пустая
4. Пункт 1: "1. Ваше Имя и Фамилия, номер ID-card : {Имя Фамилия}, {ID-card}"
5. Пункт 2: "2. Организация в которой состоит нарушитель, а также Имя и Фамилия нарушителя/его идентификационный знак : {Организация}, {Жетон/Имя}"
6. Пункт 3: "3. Подробное описание ситуации : {обработанное описание}"
   - ПРАВИЛА ОБРАБОТКИ ОПИСАНИЯ: ИСПРАВЬ все орфографические и грамматические ошибки. УБЕРИ сленг, мат и эмоции. СДЕЛАЙ текст формальным и юридически грамотным. НЕ МЕНЯЙ суть.
7. Пункт 4: "4. Дата и время произошедшего : {Дата и время}"
8. Пункт 5: "5. Материалы дела : *{ссылка/ссылки}*"
   - Извлеки URL. Оберни каждую ссылку в звездочки (*).
9. Пункт 6: "6. Ваш контактный адрес электронной почты, ксерокопия паспорта : {EMAIL}, {PASSPORT_LINK}"
   - СТРОГОЕ ПРАВИЛО ДЛЯ EMAIL: Возьми логин Discord пользователя (все что до знака #), удали пробелы и ОБЯЗАТЕЛЬНО добавь окончание "@sa.gov". 
     Пример ввода: "igr0m" -> Результат: "igr0m@sa.gov"
     Пример ввода: "kot#1234" -> Результат: "kot@sa.gov"
     Пример ввода: "test.user" -> Результат: "test.user@sa.gov"
     ВАЖНО: Если пользователь не написал @sa.gov, ты ДОЛЖЕН добавить это сам.
   - СТРОГОЕ ПРАВИЛО ДЛЯ ПАСПОРТА: Создай Markdown ссылку. Текст ссылки (анкор) ДОЛЖЕН БЫТЬ ТОЛЬКО "ксерокопия паспорта" (в нижнем регистре, без кавычек).
     Пример ввода ссылки: "https://imgur.com/123" -> Результат: "[ксерокопия паспорта](https://imgur.com/123)"
   - ИТОГОВЫЙ ПРИМЕР СТРОКИ ПУНКТА 6: "6. Ваш контактный адрес электронной почты, ксерокопия паспорта : igr0m@sa.gov, [ксерокопия паспорта](https://imgur.com/123)"
10. Пункт 7: "7. Ваша подпись и ее расшифровка : {Инициалы} / {Имя Фамилия}"
`;

export const generateComplaintText = async (data: ComplaintFormState): Promise<GeneratedComplaint